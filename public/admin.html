<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - CNG Stations</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #4CAF50; color: white; }
    tr:nth-child(even){background-color: #f2f2f2;}
    input[type="text"], input[type="number"], input[type="url"], input[type="file"] { width: 100%; padding: 4px; box-sizing: border-box; }
    button { padding: 6px 12px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #45a049; }
    .img-preview { width: 80px; height: auto; display: block; margin: auto; }
  </style>
</head>
<body>

<h1>CNG Stations Admin Dashboard</h1>

<div>
  <label>Enter City: </label>
  <input type="text" id="cityInput" placeholder="Delhi">
  <button onclick="fetchStations()">Load Stations</button>
</div>

<table id="stationsTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Address</th>
      <th>City</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Pincode</th>
      <th>Rating</th>
      <th>User Ratings</th>
      <th>Photo</th>
      <th>Update</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>

<script>
  // ----------------- FIREBASE CONFIG -----------------
  
  async function fetchStations() {
    const city = document.getElementById('cityInput').value.trim();
    if (!city) return alert('Please enter a city');

    try {
      const res = await fetch(`/stations-by-city?city=${encodeURIComponent(city)}`);
      const data = await res.json();
      if (!data.success) return alert('Failed to fetch stations');

      const tbody = document.querySelector('#stationsTable tbody');
      tbody.innerHTML = '';

      data.stations.forEach(station => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${station.id}</td>
          <td><input type="text" value="${station.name || ''}" /></td>
          <td><input type="text" value="${station.address || ''}" /></td>
          <td><input type="text" value="${station.city || ''}" /></td>
          <td><input type="number" step="0.000001" value="${station.latitude || ''}" /></td>
          <td><input type="number" step="0.000001" value="${station.longitude || ''}" /></td>
          <td><input type="text" value="${station.pincode || ''}" /></td>
          <td><input type="number" step="0.1" value="${station.rating || ''}" /></td>
          <td><input type="number" value="${station.user_ratings_total || ''}" /></td>
          <td>
            <img class="img-preview" src="${station.photoUrl || ''}" />
            <input type="file" accept="image/*" />
          </td>
          <td><button onclick="updateStation(this, '${station.id}')">Save</button></td>
        `;
        tbody.appendChild(row);
      });
    } catch (err) {
      console.error(err);
      alert('Error fetching stations');
    }
  }

 async function updateStation(button, id) {
  const row = button.closest('tr');
  const fileInput = row.querySelector('input[type="file"]');
  const file = fileInput.files[0];

  const formData = new FormData();
  formData.append('name', row.cells[1].querySelector('input').value);
  formData.append('address', row.cells[2].querySelector('input').value);
  formData.append('city', row.cells[3].querySelector('input').value);
  formData.append('latitude', row.cells[4].querySelector('input').value);
  formData.append('longitude', row.cells[5].querySelector('input').value);
  formData.append('pincode', row.cells[6].querySelector('input').value);
  formData.append('rating', row.cells[7].querySelector('input').value);
  formData.append('user_ratings_total', row.cells[8].querySelector('input').value);

  if (file) formData.append('photo', file);

  try {
    const res = await fetch(`/update-station-with-image/${id}`, {
      method: 'POST',
      body: formData
    });

    const data = await res.json();
    if (data.success) {
      alert('Station updated successfully');
      if (data.photoUrl) row.querySelector('img.img-preview').src = data.photoUrl;
      fileInput.value = '';
    } else {
      alert('Failed to update station');
    }

  } catch (err) {
    console.error(err);
    alert('Error updating station');
  }
  }
</script>
</body>
</html>
